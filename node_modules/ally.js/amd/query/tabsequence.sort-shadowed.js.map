{"version":3,"sources":["../../src/query/tabsequence.sort-shadowed.js"],"names":[],"mappings":"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","file":"tabsequence.sort-shadowed.js","sourcesContent":["\nimport getShadowHost from '../get/shadow-host';\nimport mergeInDomOrder from '../util/merge-dom-order';\nimport tabindexValue from '../util/tabindex-value';\n\nclass Shadows {\n  constructor(context, sortElements) {\n    // document context we're working with\n    this.context = context;\n    // callback that sorts an array of elements\n    this.sortElements = sortElements;\n    // reference to create unique IDs for each ShadowHost\n    this.hostCounter = 1;\n    // reference map for child-ShadowHosts of a ShadowHost\n    this.inHost = {};\n    // reference map for child-ShadowHost of the document\n    this.inDocument = [];\n    // reference map for ShadowHosts\n    this.hosts = {};\n    // reference map for tabbable elements of a ShadowHost\n    this.elements = {};\n  }\n\n  // remember which hosts we have to sort within later\n  _registerHost(host) {\n    if (host._sortingId) {\n      return;\n    }\n\n    // make the ShadowHost identifiable (see cleanup() for undo)\n    host._sortingId = 'shadow-' + (this.hostCounter++);\n    this.hosts[host._sortingId] = host;\n\n    // hosts may contain other hosts\n    const parentHost = getShadowHost({context: host});\n    if (parentHost) {\n      this._registerHost(parentHost);\n      this._registerHostParent(host, parentHost);\n    } else {\n      this.inDocument.push(host);\n    }\n  }\n\n  // remember which host is the child of which other host\n  _registerHostParent(host, parent) {\n    if (!this.inHost[parent._sortingId]) {\n      this.inHost[parent._sortingId] = [];\n    }\n\n    this.inHost[parent._sortingId].push(host);\n  }\n\n  // remember which elements a host contains\n  _registerElement(element, host) {\n    if (!this.elements[host._sortingId]) {\n      this.elements[host._sortingId] = [];\n    }\n\n    this.elements[host._sortingId].push(element);\n  }\n\n  // remove shadowed elements from the sequence and register\n  // the ShadowHosts they belong to so we know what to sort\n  // later on\n  extractElements(elements) {\n    return elements.filter(function(element) {\n      const host = getShadowHost({context: element });\n      if (!host) {\n        return true;\n      }\n\n      this._registerHost(host);\n      this._registerElement(element, host);\n      return false;\n    }, this);\n  }\n\n  // inject hosts into the sequence, sort everything,\n  // and recoursively replace hosts by its descendants\n  sort(elements) {\n    let _elements = this._injectHosts(elements);\n    _elements = this._replaceHosts(_elements);\n    this._cleanup();\n    return _elements;\n  }\n\n  // merge ShadowHosts into the element lists of other ShadowHosts\n  // or the document, then sort the individual lists\n  _injectHosts(elements) {\n    Object.keys(this.hosts).forEach(function(_sortingId) {\n      const _list = this.elements[_sortingId];\n      const _elements = this.inHost[_sortingId];\n      const _context = this.hosts[_sortingId].shadowRoot;\n      this.elements[_sortingId] = this._merge(_list, _elements, _context);\n    }, this);\n\n    return this._merge(elements, this.inDocument, this.context);\n  }\n\n  _merge(list, elements, context) {\n    const merged = mergeInDomOrder({\n      list,\n      elements,\n    });\n\n    return this.sortElements(merged, context);\n  }\n\n  _replaceHosts(elements) {\n    return mergeInDomOrder({\n      list: elements,\n      elements: this.inDocument,\n      resolveElement: this._resolveHostElement.bind(this),\n    });\n  }\n\n  _resolveHostElement(host) {\n    const merged = mergeInDomOrder({\n      list: this.elements[host._sortingId],\n      elements: this.inHost[host._sortingId],\n      resolveElement: this._resolveHostElement.bind(this),\n    });\n\n    if (tabindexValue(host)) {\n      return [host].concat(merged);\n    }\n\n    return merged;\n  }\n\n  _cleanup() {\n    // remove those identifers we put on the ShadowHost to avoid using Map()\n    Object.keys(this.hosts).forEach(function(key) {\n      delete this.hosts[key]._sortingId;\n    }, this);\n  }\n}\n\nexport default function(elements, context, sortElements) {\n  const shadows = new Shadows(context, sortElements);\n  const _elements = shadows.extractElements(elements);\n\n  if (_elements.length === elements.length) {\n    // no shadowed content found, no need to continue\n    return sortElements(elements);\n  }\n\n  return shadows.sort(_elements);\n}\n"]}