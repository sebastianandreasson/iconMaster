{"version":3,"sources":["../../src/maintain/hidden.js"],"names":[],"mappings":"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","file":"hidden.js","sourcesContent":["\n// Utility to make the entire DOM aria-hidden=\"true\" except for a given set of elements\n\nimport nodeArray from '../util/node-array';\nimport getInsignificantBranches from '../get/insignificant-branches';\nimport getParents from '../get/parents';\nimport toggleAttributeValue from '../util/toggle-attribute-value';\nimport {getParentComparator} from '../util/compare-position';\n\nfunction makeElementHidden(element) {\n  toggleAttributeValue({\n    element,\n    attribute: 'aria-hidden',\n    temporaryValue: 'true',\n  });\n}\n\nfunction undoElementHidden(element) {\n  toggleAttributeValue({\n    element,\n    attribute: 'aria-hidden',\n  });\n}\n\nconst observerConfig = {\n  attributes: false,\n  childList: true,\n  subtree: true,\n};\n\nclass HiddenSubtree {\n  constructor({context, filter} = {}) {\n    this._context = nodeArray(context || document.documentElement)[0];\n    this._filter = nodeArray(filter);\n\n    this.disengage = this.disengage.bind(this);\n    this.handleMutation = this.handleMutation.bind(this);\n    this.isInsignificantBranch = this.isInsignificantBranch.bind(this);\n\n    const insignificantBranches = getInsignificantBranches({context: this._context, filter: this._filter});\n    insignificantBranches.forEach(makeElementHidden);\n    this.startObserver();\n  }\n\n  disengage() {\n    if (!this._context) {\n      return;\n    }\n\n    [].forEach.call(this._context.querySelectorAll('[data-cached-aria-hidden]'), undoElementHidden);\n\n    this._context = null;\n    this._filter = null;\n    this._observer && this._observer.disconnect();\n    this._observer = null;\n  }\n\n  startObserver() {\n    if (!window.MutationObserver) {\n      // not supporting IE10 via Mutation Events, because they're too expensive\n      // https://developer.mozilla.org/en-US/docs/Web/Guide/Events/Mutation_events\n      return;\n    }\n    // http://caniuse.com/#search=mutation\n    // https://developer.mozilla.org/en-US/docs/Web/API/MutationObserver\n    this._observer = new MutationObserver(mutations => mutations.forEach(this.handleMutation));\n    this._observer.observe(this._context, observerConfig);\n  }\n\n  handleMutation(mutation) {\n    if (mutation.type === 'childList') {\n      const addedElements = nodeArray(mutation.addedNodes).filter(element => element.nodeType === Node.ELEMENT_NODE);\n      if (!addedElements.length) {\n        return;\n      }\n\n      // a new branch cannot contain a filtered element\n      // (unless it is moved there, which is an edge-case we'll ignore for now),\n      // so anything that is within context,\n      // and not within a previously known insignificant branch and not within a filtered element,\n      // must be an insignificant branch as well\n      const insignificantBranches = addedElements.filter(this.isInsignificantBranch);\n      insignificantBranches.forEach(makeElementHidden);\n    }\n  }\n\n  isInsignificantBranch(element) {\n    const parents = getParents({context: element});\n    if (parents.some(_element => _element.getAttribute('aria-hidden') === 'true')) {\n      // element is child of a hidden element\n      return false;\n    }\n\n    const isParentOfElement = getParentComparator({element});\n    if (this._filter.some(isParentOfElement)) {\n      // element is a descendant of a filtered element\n      return false;\n    }\n\n    return true;\n  }\n}\n\nexport default function({context, filter} = {}) {\n  const service = new HiddenSubtree({context, filter});\n  return { disengage: service.disengage };\n}\n"]}