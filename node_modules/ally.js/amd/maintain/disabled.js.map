{"version":3,"sources":["../../src/maintain/disabled.js"],"names":[],"mappings":"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","file":"disabled.js","sourcesContent":["\n/*\n  Utility to make a sub-tree of the DOM inert. Inert means the elements cannot be interacted\n  with and they cannot be focused via script, pointer or keyboard.\n\n  inert attribute was [removed](https://html5.org/r/8536) [tweet by steve](https://twitter.com/stevefaulkner/status/443075900201259008)\n  but definition of [inert subtrees](http://www.w3.org/html/wg/drafts/html/master/editing.html#inert-subtrees) remains.\n\n  [implementation idea by Vasilis](http://codepen.io/vasilisvg/pen/scowI)\n  [inert attribute polyfill by GoogleChrome](https://github.com/GoogleChrome/inert-polyfill)\n\n  [Gecko Bug: Inert Attribute](https://bugzilla.mozilla.org/show_bug.cgi?id=921504)\n  [Chromium Bug: Inert Attribute](https://code.google.com/p/chromium/issues/detail?id=269846)\n  [Chromium Bug: Inert Subtree](https://code.google.com/p/chromium/issues/detail?id=241699)\n  [WebKit Bug: Inert Subtree](https://bugs.webkit.org/show_bug.cgi?id=110952)\n*/\n\nimport nodeArray from '../util/node-array';\nimport queryFocusable from '../query/focusable';\nimport elementDisabled from '../element/disabled';\nimport {getParentComparator} from '../util/compare-position';\n\nfunction makeElementInert(element) {\n  return elementDisabled(element, true);\n}\n\nfunction undoElementInert(element) {\n  return elementDisabled(element, false);\n}\n\nconst observerConfig = {\n  attributes: true,\n  childList: true,\n  subtree: true,\n  attributeFilter: ['tabindex'],\n};\n\nclass InertSubtree {\n  constructor({context, filter} = {}) {\n    this._context = nodeArray(context || document.documentElement)[0];\n    this._filter = nodeArray(filter);\n\n    this.disengage = this.disengage.bind(this);\n    this.handleMutation = this.handleMutation.bind(this);\n    this.renderInert = this.renderInert.bind(this);\n    this.filterElements = this.filterElements.bind(this);\n\n    const focusable = queryFocusable({\n      context: this._context,\n      includeContext: true,\n      strategy: 'all',\n    });\n\n    this.renderInert(focusable);\n    this.startObserver();\n  }\n\n  disengage() {\n    if (!this._context) {\n      return;\n    }\n\n    undoElementInert(this._context);\n    [].forEach.call(this._context.querySelectorAll('[data-ally-disabled], :disabled'), undoElementInert);\n\n    this._filter = null;\n    this._context = null;\n    this._observer && this._observer.disconnect();\n    this._observer = null;\n  }\n\n  listQueryFocusable(list) {\n    return list\n      // find all focusable elements within the given contexts\n      .map(element => queryFocusable({context: element, includeContext: true, strategy: 'all'}))\n      // flatten nested arrays\n      .reduce((previous, current) => previous.concat(current), []);\n  }\n\n  renderInert(elements) {\n    elements.filter(this.filterElements).forEach(makeElementInert);\n  }\n\n  filterContext(element) {\n    // ignore elements that are not within the context sub-trees\n    const isParentOfElement = getParentComparator({element, includeSelf: true});\n    return isParentOfElement(this._context);\n  }\n\n  filterElements(element) {\n    if (element === document.body && !element.hasAttribute('tabindex')) {\n      // ignore the body (default focus element) unless it was made focusable\n      return false;\n    }\n\n    // ignore elements within the exempted sub-trees\n    const isParentOfElement = getParentComparator({element, includeSelf: true});\n    return !this._filter.some(isParentOfElement);\n  }\n\n  startObserver() {\n    if (!window.MutationObserver) {\n      // not supporting IE10 via Mutation Events, because they're too expensive\n      // https://developer.mozilla.org/en-US/docs/Web/Guide/Events/Mutation_events\n      return;\n    }\n    // http://caniuse.com/#search=mutation\n    // https://developer.mozilla.org/en-US/docs/Web/API/MutationObserver\n    this._observer = new MutationObserver(mutations => mutations.forEach(this.handleMutation));\n    this._observer.observe(this._context, observerConfig);\n  }\n\n  handleMutation(mutation) {\n    if (mutation.type === 'childList') {\n      const addedElements = nodeArray(mutation.addedNodes).filter(element => element.nodeType === Node.ELEMENT_NODE);\n      if (!addedElements.length) {\n        return;\n      }\n\n      const addedFocusableElements = this.listQueryFocusable(addedElements);\n      this.renderInert(addedFocusableElements);\n    } else if (mutation.type === 'attribute' && !this.filterElements(mutation.target) && this.filterContext(mutation.target)) {\n      makeElementInert(mutation.target);\n    }\n  }\n}\n\nexport default function({context, filter} = {}) {\n  const service = new InertSubtree({context, filter});\n  return { disengage: service.disengage };\n}\n"]}