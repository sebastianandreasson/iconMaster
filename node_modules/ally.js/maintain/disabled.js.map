{"version":3,"sources":["../../src/maintain/disabled.js"],"names":[],"mappings":"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","file":"disabled.js","sourcesContent":["\n/*\n  Utility to make a sub-tree of the DOM inert. Inert means the elements cannot be interacted\n  with and they cannot be focused via script, pointer or keyboard.\n\n  inert attribute was [removed](https://html5.org/r/8536) [tweet by steve](https://twitter.com/stevefaulkner/status/443075900201259008)\n  but definition of [inert subtrees](http://www.w3.org/html/wg/drafts/html/master/editing.html#inert-subtrees) remains.\n\n  [implementation idea by Vasilis](http://codepen.io/vasilisvg/pen/scowI)\n  [inert attribute polyfill by GoogleChrome](https://github.com/GoogleChrome/inert-polyfill)\n\n  [Gecko Bug: Inert Attribute](https://bugzilla.mozilla.org/show_bug.cgi?id=921504)\n  [Chromium Bug: Inert Attribute](https://code.google.com/p/chromium/issues/detail?id=269846)\n  [Chromium Bug: Inert Subtree](https://code.google.com/p/chromium/issues/detail?id=241699)\n  [WebKit Bug: Inert Subtree](https://bugs.webkit.org/show_bug.cgi?id=110952)\n*/\n\nimport nodeArray from '../util/node-array';\nimport queryFocusable from '../query/focusable';\nimport elementDisabled from '../element/disabled';\nimport {getParentComparator} from '../util/compare-position';\n\nfunction makeElementInert(element) {\n  return elementDisabled(element, true);\n}\n\nfunction undoElementInert(element) {\n  return elementDisabled(element, false);\n}\n\nconst observerConfig = {\n  attributes: true,\n  childList: true,\n  subtree: true,\n  attributeFilter: ['tabindex'],\n};\n\nclass InertSubtree {\n  constructor({context, filter} = {}) {\n    this._context = nodeArray(context || document.documentElement)[0];\n    this._filter = nodeArray(filter);\n\n    this.disengage = this.disengage.bind(this);\n    this.handleMutation = this.handleMutation.bind(this);\n    this.renderInert = this.renderInert.bind(this);\n    this.filterElements = this.filterElements.bind(this);\n\n    const focusable = queryFocusable({\n      context: this._context,\n      includeContext: true,\n      strategy: 'all',\n    });\n\n    this.renderInert(focusable);\n    this.startObserver();\n  }\n\n  disengage() {\n    if (!this._context) {\n      return;\n    }\n\n    undoElementInert(this._context);\n    [].forEach.call(this._context.querySelectorAll('[data-ally-disabled], :disabled'), undoElementInert);\n\n    this._filter = null;\n    this._context = null;\n    this._observer && this._observer.disconnect();\n    this._observer = null;\n  }\n\n  listQueryFocusable(list) {\n    return list\n      // find all focusable elements within the given contexts\n      .map(element => queryFocusable({context: element, includeContext: true, strategy: 'all'}))\n      // flatten nested arrays\n      .reduce((previous, current) => previous.concat(current), []);\n  }\n\n  renderInert(elements) {\n    elements.filter(this.filterElements).forEach(makeElementInert);\n  }\n\n  filterContext(element) {\n    // ignore elements that are not within the context sub-trees\n    const isParentOfElement = getParentComparator({element, includeSelf: true});\n    return isParentOfElement(this._context);\n  }\n\n  filterElements(element) {\n    if (element === document.body && !element.hasAttribute('tabindex')) {\n      // ignore the body (default focus element) unless it was made focusable\n      return false;\n    }\n\n    // ignore elements within the exempted sub-trees\n    const isParentOfElement = getParentComparator({element, includeSelf: true});\n    return !this._filter.some(isParentOfElement);\n  }\n\n  startObserver() {\n    if (!window.MutationObserver) {\n      // not supporting IE10 via Mutation Events, because they're too expensive\n      // https://developer.mozilla.org/en-US/docs/Web/Guide/Events/Mutation_events\n      return;\n    }\n    // http://caniuse.com/#search=mutation\n    // https://developer.mozilla.org/en-US/docs/Web/API/MutationObserver\n    this._observer = new MutationObserver(mutations => mutations.forEach(this.handleMutation));\n    this._observer.observe(this._context, observerConfig);\n  }\n\n  handleMutation(mutation) {\n    if (mutation.type === 'childList') {\n      const addedElements = nodeArray(mutation.addedNodes).filter(element => element.nodeType === Node.ELEMENT_NODE);\n      if (!addedElements.length) {\n        return;\n      }\n\n      const addedFocusableElements = this.listQueryFocusable(addedElements);\n      this.renderInert(addedFocusableElements);\n    } else if (mutation.type === 'attribute' && !this.filterElements(mutation.target) && this.filterContext(mutation.target)) {\n      makeElementInert(mutation.target);\n    }\n  }\n}\n\nexport default function({context, filter} = {}) {\n  const service = new InertSubtree({context, filter});\n  return { disengage: service.disengage };\n}\n"]}